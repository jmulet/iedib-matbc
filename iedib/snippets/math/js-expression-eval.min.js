Array.indexOf||(Array.prototype.indexOf=function(obj,start){for(var i=start||0;i<this.length;i++)if(this[i]===obj)return i;return-1});var Parser=function(scope){function object(o){function F(){}return F.prototype=o,new F}var TNUMBER=0,TOP1=1,TOP2=2,TVAR=3,TFUNCALL=4;function Token(type_,index_,prio_,number_){this.type_=type_,this.index_=index_||0,this.prio_=prio_||0,this.number_=null!=number_?number_:0,this.toString=function(){switch(this.type_){case 0:return this.number_;case 1:case 2:case 3:return this.index_;case 4:return"CALL";default:return"Invalid Token"}}}function Expression(tokens,ops1,ops2,functions){this.tokens=tokens,this.ops1=ops1,this.ops2=ops2,this.functions=functions}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"};function escapeValue(v){return"string"==typeof v?(escapable.lastIndex=0,escapable.test(v)?"'"+v.replace(escapable,(function(a){var c=meta[a];return"string"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}))+"'":"'"+v+"'"):v}function add(a,b){return Number(a)+Number(b)}function sub(a,b){return a-b}function mul(a,b){return a*b}function div(a,b){return a/b}function mod(a,b){return a%b}function concat(a,b){return""+a+b}function equal(a,b){return a==b}function notEqual(a,b){return a!=b}function greaterThan(a,b){return a>b}function lessThan(a,b){return a<b}function greaterThanEqual(a,b){return a>=b}function lessThanEqual(a,b){return a<=b}function andOperator(a,b){return Boolean(a&&b)}function orOperator(a,b){return Boolean(a||b)}function sinh(a){return Math.sinh?Math.sinh(a):(Math.exp(a)-Math.exp(-a))/2}function cosh(a){return Math.cosh?Math.cosh(a):(Math.exp(a)+Math.exp(-a))/2}function tanh(a){return Math.tanh?Math.tanh(a):a===1/0?1:a===-1/0?-1:(Math.exp(a)-Math.exp(-a))/(Math.exp(a)+Math.exp(-a))}function asinh(a){return Math.asinh?Math.asinh(a):a===-1/0?a:Math.log(a+Math.sqrt(a*a+1))}function acosh(a){return Math.acosh?Math.acosh(a):Math.log(a+Math.sqrt(a*a-1))}function atanh(a){return Math.atanh?Math.atanh(a):Math.log((1+a)/(1-a))/2}function log10(a){return Math.log(a)*Math.LOG10E}function neg(a){return-a}function trunc(a){return Math.trunc?Math.trunc(a):x<0?Math.ceil(x):Math.floor(x)}function random(a){return Math.random()*(a||1)}function fac(a){for(var b=a=Math.floor(a);a>1;)b*=--a;return b}function hypot(){if(Math.hypot)return Math.hypot.apply(this,arguments);for(var y=0,length=arguments.length,i=0;i<length;i++){if(arguments[i]===1/0||arguments[i]===-1/0)return 1/0;y+=arguments[i]*arguments[i]}return Math.sqrt(y)}function condition(cond,yep,nope){return cond?yep:nope}function len(val){return void 0===val&&(val=""),val.toString().length}function decimalAdjust(type,value,exp){return void 0===exp||0==+exp?Math[type](value):(value=+value,exp=-+exp,isNaN(value)||"number"!=typeof exp||exp%1!=0?NaN:(value=value.toString().split("e"),+((value=(value=Math[type](+(value[0]+"e"+(value[1]?+value[1]-exp:-exp)))).toString().split("e"))[0]+"e"+(value[1]?+value[1]+exp:exp))))}function round(value,exp){return value instanceof Array&&(exp=value[1],value=value[0]),decimalAdjust("round",value,exp)}function append(a,b){return"[object Array]"!=Object.prototype.toString.call(a)?[a,b]:((a=a.slice()).push(b),a)}function Parser(){this.success=!1,this.errormsg="",this.expression="",this.pos=0,this.tokennumber=0,this.tokenprio=0,this.tokenindex=0,this.tmpprio=0,this.ops1={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:sinh,cosh:cosh,tanh:tanh,asinh:asinh,acosh:acosh,atanh:atanh,sqrt:Math.sqrt,log:Math.log,lg:log10,log10:log10,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:round,trunc:trunc,"-":neg,exp:Math.exp},this.ops2={"+":add,"-":sub,"*":mul,"/":div,"%":mod,"^":Math.pow,",":append,"||":concat,"==":equal,"!=":notEqual,">":greaterThan,"<":lessThan,">=":greaterThanEqual,"<=":lessThanEqual,and:andOperator,or:orOperator},this.functions={random:random,fac:fac,min:Math.min,max:Math.max,hypot:hypot,pyt:hypot,pow:Math.pow,atan2:Math.atan2,if:condition,len:len},this.consts={E:Math.E,PI:Math.PI}}Expression.prototype={simplify:function(values){values=values||{};var nstack=[],newexpression=[],n1,n2,f,L=this.tokens.length,item,i=0;for(i=0;i<L;i++){var type_=(item=this.tokens[i]).type_;if(0===type_)nstack.push(item);else if(3===type_&&item.index_ in values)item=new Token(0,0,0,values[item.index_]),nstack.push(item);else if(2===type_&&nstack.length>1)n2=nstack.pop(),n1=nstack.pop(),item=new Token(0,0,0,(f=this.ops2[item.index_])(n1.number_,n2.number_)),nstack.push(item);else if(1===type_&&nstack.length>0)n1=nstack.pop(),item=new Token(0,0,0,(f=this.ops1[item.index_])(n1.number_)),nstack.push(item);else{for(;nstack.length>0;)newexpression.push(nstack.shift());newexpression.push(item)}}for(;nstack.length>0;)newexpression.push(nstack.shift());return new Expression(newexpression,object(this.ops1),object(this.ops2),object(this.functions))},substitute:function(variable,expr){expr instanceof Expression||(expr=(new Parser).parse(String(expr)));var newexpression=[],L=this.tokens.length,item,i=0,ret;for(i=0;i<L;i++){var type_;if(3===(item=this.tokens[i]).type_&&item.index_===variable)for(var j=0;j<expr.tokens.length;j++){var expritem=expr.tokens[j],replitem=new Token(expritem.type_,expritem.index_,expritem.prio_,expritem.number_);newexpression.push(replitem)}else newexpression.push(item)}return new Expression(newexpression,object(this.ops1),object(this.ops2),object(this.functions))},evaluate:function(values){values=values||{};var nstack=[],n1,n2,f,L=this.tokens.length,item,i=0;for(i=0;i<L;i++){var type_=(item=this.tokens[i]).type_;if(0===type_)nstack.push(item.number_);else if(2===type_)n2=nstack.pop(),n1=nstack.pop(),f=this.ops2[item.index_],nstack.push(f(n1,n2));else if(3===type_)if(item.index_ in values)nstack.push(values[item.index_]);else{if(!(item.index_ in this.functions))throw new Error("undefined variable: "+item.index_);nstack.push(this.functions[item.index_])}else if(1===type_)n1=nstack.pop(),f=this.ops1[item.index_],nstack.push(f(n1));else{if(4!==type_)throw new Error("invalid Expression");if(n1=nstack.pop(),!(f=nstack.pop()).apply||!f.call)throw new Error(f+" is not a function");"[object Array]"==Object.prototype.toString.call(n1)?nstack.push(f.apply(void 0,n1)):nstack.push(f.call(void 0,n1))}}if(nstack.length>1)throw new Error("invalid Expression (parity)");return nstack[0]},toString:function(toJS){var nstack=[],n1,n2,f,L=this.tokens.length,item,i=0;for(i=0;i<L;i++){var type_=(item=this.tokens[i]).type_;if(0===type_)nstack.push(escapeValue(item.number_));else if(2===type_)n2=nstack.pop(),n1=nstack.pop(),f=item.index_,toJS&&"^"==f?nstack.push("Math.pow("+n1+","+n2+")"):nstack.push("("+n1+f+n2+")");else if(3===type_)nstack.push(item.index_);else if(1===type_)n1=nstack.pop(),"-"===(f=item.index_)?nstack.push("("+f+n1+")"):nstack.push(f+"("+n1+")");else{if(4!==type_)throw new Error("invalid Expression");n1=nstack.pop(),f=nstack.pop(),nstack.push(f+"("+n1+")")}}if(nstack.length>1)throw new Error("invalid Expression (parity)");return nstack[0]},variables:function(){for(var L=this.tokens.length,vars=[],i=0;i<L;i++){var item=this.tokens[i];3===item.type_&&-1==vars.indexOf(item.index_)&&vars.push(item.index_)}return vars},toJSFunction:function(param,variables){var f;return new Function(param,"with(Parser.values) { return "+this.simplify(variables).toString(!0)+"; }")}},Parser.parse=function(expr){return(new Parser).parse(expr)},Parser.evaluate=function(expr,variables){return Parser.parse(expr).evaluate(variables)},Parser.Expression=Expression,Parser.values={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:sinh,cosh:cosh,tanh:tanh,asinh:asinh,acosh:acosh,atanh:atanh,sqrt:Math.sqrt,log:Math.log,lg:log10,log10:log10,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:round,trunc:trunc,random:random,fac:fac,exp:Math.exp,min:Math.min,max:Math.max,hypot:hypot,pyt:hypot,pow:Math.pow,atan2:Math.atan2,if:condition,len:len,E:Math.E,PI:Math.PI};var PRIMARY=1,OPERATOR=2,FUNCTION=4,LPAREN=8,RPAREN=16,COMMA=32,SIGN=64,CALL=128,NULLARY_CALL=256;return Parser.prototype={parse:function(expr){this.errormsg="",this.success=!0;var operstack=[],tokenstack=[];this.tmpprio=0;var expected=77,noperators=0;for(this.expression=expr,this.pos=0;this.pos<this.expression.length;)if(this.isOperator())this.isSign()&&64&expected?(this.isNegativeSign()&&(this.tokenprio=2,this.tokenindex="-",noperators++,this.addfunc(tokenstack,operstack,1)),expected=77):this.isComment()||(0==(2&expected)&&this.error_parsing(this.pos,"unexpected operator"),noperators+=2,this.addfunc(tokenstack,operstack,2),expected=77);else if(this.isNumber()){0==(1&expected)&&this.error_parsing(this.pos,"unexpected number");var token=new Token(0,0,0,this.tokennumber);tokenstack.push(token),expected=50}else if(this.isString()){0==(1&expected)&&this.error_parsing(this.pos,"unexpected string");var token=new Token(0,0,0,this.tokennumber);tokenstack.push(token),expected=50}else if(this.isLeftParenth())0==(8&expected)&&this.error_parsing(this.pos,'unexpected "("'),128&expected&&(noperators+=2,this.tokenprio=-2,this.tokenindex=-1,this.addfunc(tokenstack,operstack,4)),expected=333;else if(this.isRightParenth()){if(256&expected){var token=new Token(0,0,0,[]);tokenstack.push(token)}else 0==(16&expected)&&this.error_parsing(this.pos,'unexpected ")"');expected=186}else if(this.isComma())0==(32&expected)&&this.error_parsing(this.pos,'unexpected ","'),this.addfunc(tokenstack,operstack,2),noperators+=2,expected=77;else if(this.isConst()){0==(1&expected)&&this.error_parsing(this.pos,"unexpected constant");var consttoken=new Token(0,0,0,this.tokennumber);tokenstack.push(consttoken),expected=50}else if(this.isOp2())0==(4&expected)&&this.error_parsing(this.pos,"unexpected function"),this.addfunc(tokenstack,operstack,2),noperators+=2,expected=8;else if(this.isOp1())0==(4&expected)&&this.error_parsing(this.pos,"unexpected function"),this.addfunc(tokenstack,operstack,1),noperators++,expected=8;else if(this.isVar()){0==(1&expected)&&this.error_parsing(this.pos,"unexpected variable");var vartoken=new Token(3,this.tokenindex,0,0);tokenstack.push(vartoken),expected=186}else this.isWhite()||(""===this.errormsg?this.error_parsing(this.pos,"unknown character"):this.error_parsing(this.pos,this.errormsg));for((this.tmpprio<0||this.tmpprio>=10)&&this.error_parsing(this.pos,'unmatched "()"');operstack.length>0;){var tmp=operstack.pop();tokenstack.push(tmp)}return noperators+1!==tokenstack.length&&this.error_parsing(this.pos,"parity"),new Expression(tokenstack,object(this.ops1),object(this.ops2),object(this.functions))},evaluate:function(expr,variables){return this.parse(expr).evaluate(variables)},error_parsing:function(column,msg){throw this.success=!1,this.errormsg="parse error [column "+column+"]: "+msg,this.column=column,new Error(this.errormsg)},addfunc:function(tokenstack,operstack,type_){for(var operator=new Token(type_,this.tokenindex,this.tokenprio+this.tmpprio,0);operstack.length>0&&operator.prio_<=operstack[operstack.length-1].prio_;)tokenstack.push(operstack.pop());operstack.push(operator)},isNumber:function(){for(var r=!1,str="";this.pos<this.expression.length;){var code=this.expression.charCodeAt(this.pos);if(!(code>=48&&code<=57||46===code))break;str+=this.expression.charAt(this.pos),this.pos++,this.tokennumber=parseFloat(str),r=!0}return r},unescape:function(v,pos){for(var buffer=[],escaping=!1,i=0;i<v.length;i++){var c=v.charAt(i);if(escaping){switch(c){case"'":buffer.push("'");break;case"\\":buffer.push("\\");break;case"/":buffer.push("/");break;case"b":buffer.push("\b");break;case"f":buffer.push("\f");break;case"n":buffer.push("\n");break;case"r":buffer.push("\r");break;case"t":buffer.push("\t");break;case"u":var codePoint=parseInt(v.substring(i+1,i+5),16);buffer.push(String.fromCharCode(codePoint)),i+=4;break;default:throw this.error_parsing(pos+i,"Illegal escape sequence: '\\"+c+"'")}escaping=!1}else"\\"==c?escaping=!0:buffer.push(c)}return buffer.join("")},isString:function(){var r=!1,str="",startpos=this.pos;if(this.pos<this.expression.length&&"'"==this.expression.charAt(this.pos))for(this.pos++;this.pos<this.expression.length;){var code;if("'"==this.expression.charAt(this.pos)&&"\\"!=str.slice(-1)){this.pos++,this.tokennumber=this.unescape(str,startpos),r=!0;break}str+=this.expression.charAt(this.pos),this.pos++}return r},isConst:function(){var str;for(var i in this.consts){var L=i.length;if(i===(str=this.expression.substr(this.pos,L)))return this.tokennumber=this.consts[i],this.pos+=L,!0}return!1},isOperator:function(){var code=this.expression.charCodeAt(this.pos);if(43===code)this.tokenprio=2,this.tokenindex="+";else if(45===code)this.tokenprio=2,this.tokenindex="-";else if(62===code)61===this.expression.charCodeAt(this.pos+1)?(this.pos++,this.tokenprio=1,this.tokenindex=">="):(this.tokenprio=1,this.tokenindex=">");else if(60===code)61===this.expression.charCodeAt(this.pos+1)?(this.pos++,this.tokenprio=1,this.tokenindex="<="):(this.tokenprio=1,this.tokenindex="<");else if(124===code){if(124!==this.expression.charCodeAt(this.pos+1))return!1;this.pos++,this.tokenprio=1,this.tokenindex="||"}else if(61===code){if(61!==this.expression.charCodeAt(this.pos+1))return!1;this.pos++,this.tokenprio=1,this.tokenindex="=="}else if(33===code){if(61!==this.expression.charCodeAt(this.pos+1))return!1;this.pos++,this.tokenprio=1,this.tokenindex="!="}else if(97===code){if(110!==this.expression.charCodeAt(this.pos+1)||100!==this.expression.charCodeAt(this.pos+2))return!1;this.pos++,this.pos++,this.tokenprio=0,this.tokenindex="and"}else if(111===code){if(114!==this.expression.charCodeAt(this.pos+1))return!1;this.pos++,this.tokenprio=0,this.tokenindex="or"}else if(42===code||8729===code||8226===code)this.tokenprio=3,this.tokenindex="*";else if(47===code)this.tokenprio=4,this.tokenindex="/";else if(37===code)this.tokenprio=4,this.tokenindex="%";else{if(94!==code)return!1;this.tokenprio=5,this.tokenindex="^"}return this.pos++,!0},isSign:function(){var code=this.expression.charCodeAt(this.pos-1);return 45===code||43===code},isPositiveSign:function(){var code;return 43===this.expression.charCodeAt(this.pos-1)},isNegativeSign:function(){var code;return 45===this.expression.charCodeAt(this.pos-1)},isLeftParenth:function(){var code;return 40===this.expression.charCodeAt(this.pos)&&(this.pos++,this.tmpprio+=10,!0)},isRightParenth:function(){var code;return 41===this.expression.charCodeAt(this.pos)&&(this.pos++,this.tmpprio-=10,!0)},isComma:function(){var code;return 44===this.expression.charCodeAt(this.pos)&&(this.pos++,this.tokenprio=-1,this.tokenindex=",",!0)},isWhite:function(){var code=this.expression.charCodeAt(this.pos);return(32===code||9===code||10===code||13===code)&&(this.pos++,!0)},isOp1:function(){for(var str="",i=this.pos;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase()&&(i===this.pos||"_"!=c&&(c<"0"||c>"9")))break;str+=c}return str.length>0&&str in this.ops1&&(this.tokenindex=str,this.tokenprio=5,this.pos+=str.length,!0)},isOp2:function(){for(var str="",i=this.pos;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase()&&(i===this.pos||"_"!=c&&(c<"0"||c>"9")))break;str+=c}return str.length>0&&str in this.ops2&&(this.tokenindex=str,this.tokenprio=5,this.pos+=str.length,!0)},isVar:function(){for(var str="",i=this.pos;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase()&&(i===this.pos||"_"!=c&&(c<"0"||c>"9")))break;str+=c}return str.length>0&&(this.tokenindex=str,this.tokenprio=4,this.pos+=str.length,!0)},isComment:function(){var code;return 47===this.expression.charCodeAt(this.pos-1)&&42===this.expression.charCodeAt(this.pos)&&(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0)}},scope.Parser=Parser,Parser}("undefined"==typeof exports?{}:exports);